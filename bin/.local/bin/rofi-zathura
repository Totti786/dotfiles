#!/bin/bash

cached="$HOME/.cache/zcache"
history="$HOME/.local/share/zathura/history"

if [[ ! -d $HOME/.cache/zcache ]]; then mkdir $cached ; fi 

> $cached/zlist

grep -i "home" $history  | tr -d "[]" | while read -r line ; do
	type=$(file "$line" | cut -d ":" -f2 | cut -d " " -f2)
	name=$(echo "$line" | rev | cut -d "/" -f1 | rev)
	if [ "$type" == "PDF" ] || [ "$type" == "EPUB" ]; then 
		if [ "$type" == "PDF" ]; then
			#if ! [[ -f "$cached/$name.png" ]]; then
				#evince-thumbnailer -s 350 "$line" $cached/"$name".png &> /dev/null;
			#fi
			echo "'$(dirname "$line")'/'$(basename -s .pdf "$line")''.pdf'" >> "$cached/zlist"
		elif [ "$type" == "EPUB" ]; then
			#if ! [[ -f "$cached/$name.png" ]]; then
				#gnome-epub-thumbnailer "$line" $cached/"$name".png &> /dev/null;
			#fi
			echo "'$(dirname "$line")'/'$(basename -s .epub "$line")''.epub'" >> "$cached/zlist"
		fi
	fi
done

book=$(tac $HOME/.cache/zcache/zlist |  grep -o "/'.*'" | tr -d "'" | tr -d "/" | sed "s/\..*//g" | rofi -dmenu -p "Zathura" -markup-rows -theme ~/.config/rofi/themes/Zselect.rasi)

if ! [[ -z $book ]]; then 
	zathura "$(grep "$book" "$HOME/.cache/zcache/zlist" | tr -d "'")" &
fi
