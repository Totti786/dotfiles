#!/usr/bin/env bash

cached="$HOME/.cache/rofi-zathura"
history="$HOME/.local/share/zathura/history"
mkdir -p "$HOME/.local/share/applications/books"
mkdir -p "$cached"

main() {
	readarray -t lines < <(grep -i "home" "$history" | tr -d "[]")
	for line in "${lines[@]}"; do
		[[ -f "$line" ]] && name="${line##*/}" name="${name%.*}"
		type=${line##*.}
		if [[ "$type" == "pdf" ]] && ! [[ -f "$cached/$name.png" ]]; then
			evince-thumbnailer -s 300 "$line" "$cached/$name.png"
		elif [[ "$type" == "epub" ]] && ! [[ -f "$cached/$name.png" ]]; then
			gnome-epub-thumbnailer -s 200 "$line" "$cached/$name.png"
		elif [[ "$type" == "cbz" ]] && ! [[ -f "$cached/$name.png" ]]; then
			evince-thumbnailer -s 300 "$line" "$cached/$name.png"
		fi &> /dev/null
		
		book="$HOME/.local/share/applications/books/$name.desktop"
		if [[ ! -f "$book" ]]; then
			cat > "$book" <<- EOF
			[Desktop Entry]
			Name=$name
			Exec=zathura '$line'
			Icon=$cached/$name.png
			Type=Application
			Categories=Books;
			EOF
		fi
	done
	
	rofi -show drun -drun-categories Books -theme rofi-zathura
}

if [[ $(grep -i "home" "$history") ]]; then 
	[[ -z "$(ls -A $cached)" ]] && notify-send -t 2000 -r 40 "Rofi-Zathura" "Generating Thumbnails..."
	main && rm "$HOME"/.local/share/applications/books/*
else
	notify-send -t 2000 -r 41 "Rofi-Zathura" "No Documents Were Found"
fi

