#!/usr/bin/env bash

cached="$HOME/.cache/zcache"
history="$HOME/.local/share/zathura/history"
mkdir -p "$cached"
mkdir -p "$HOME/.local/share/applications/Books"

main() {
	readarray -t lines < <(grep -i "home" "$history" | tr -d "[]")
	for line in "${lines[@]}"; do
		[[ -f "$line" ]] && name1="${line##*/}" name="${name1%.*}"
		type=${line##*.}
		if [[ "$type" == "pdf" ]] && ! [[ -f "$cached/$name.png" ]]; then
			evince-thumbnailer -s 370 "$line" "$cached/$name.png" &> /dev/null;
		elif [[ "$type" == "cbz" ]] && ! [[ -f "$cached/$name.png" ]]; then
			evince-thumbnailer -s 370 "$line" "$cached/$name.png" &> /dev/null;
		elif [[ "$type" == "epub" ]] && ! [[ -f "$cached/$name.png" ]]; then
			gnome-epub-thumbnailer "$line" "$cached/$name.png" &> /dev/null;
		fi
		
		desktop="$HOME/.local/share/applications/Books/$name.desktop"
		if [[ ! -f "$desktop" ]]; then
			cat > "$desktop" <<- EOF
			[Desktop Entry]
			Name=$name
			Exec=zathura '$line'
			Icon=~/.cache/zcache/$name.png
			Type=Application
			Categories=Books;
			EOF
		fi
	done

	rofi -show drun -drun-categories Books -theme rofi-zathura
}

if [[ $(grep -i "home" "$history") ]]; then 
	main && rm "$HOME"/.local/share/applications/Books/*
else
	notify-send -r 41 "Rofi-Zathura" "No Documents Were Found"
fi

