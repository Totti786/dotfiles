#!/bin/bash

time="$(date +%Y-%m-%d-%I-%M-%S)"
geometry="$(xdpyinfo | awk '/dimensions/{print $2}' | cut -d 'x' -f2)"
dir="$(xdg-user-dir PICTURES)/Screenshots"
file="$dir/Screenshot_${time}_${geometry}.png"

[ ! -d $dir ] && mkdir -p $dir

notify_user() {
	notify-send -a Clipboard -i $clipboard_icon -u low -r 83 "Clipboard" "Screenshot saved on clipboard"
	if [[ -e $file ]]; then
		notify-send -a Screenshot -r 83 -u low -i $file "Screenshot Saved"
	else
		notify-send -a Screenshot -r 83 -u low "Screenshot Deleted"
	fi
}

countdown() {
	for sec in `seq $1 -1 1`; do
		notify-send -a Clock -u low -r 79 "Countdown" "Taking shot in : $sec"
		sleep 1
	done
}

magic() {
	convert $file +antialias \
	\( +clone  -alpha extract \
    -draw 'fill black polygon 0,0 0,20 20,0 fill white circle 20,20 20,0' \
    \( +clone -flip \) -compose Multiply -composite \
    \( +clone -flop \) -compose Multiply -composite \
  	\) -alpha off -compose CopyOpacity -composite $file

	convert $file \
	\( +clone -background black -shadow 69x20+0+10 \) \
	+swap -background none -layers merge +repage $file
}

shot() {
	if [ "$XDG_SESSION_TYPE" == "wayland" ]; then 
		grim $file && wl-copy < $file
	else
		maim -u -f png $file && xclip -selection clipboard -t image/png -i $file
	fi
	notify_user
}

shot_window() {
	if [ "$XDG_SESSION_TYPE" == "wayland" ]; then 
		grim $file && wl-copy < $file
	else
		maim -u -f png -i `xdotool getactivewindow` $file && xclip -selection clipboard -t image/png -i $file
	fi	
	notify_user	
}

shot_area() {
	if [ "$XDG_SESSION_TYPE" == "wayland" ]; then
		grim -g "$(slurp -c cba6f788 -b 00000055)" $file && wl-copy < $file
	else
		maim -u -f png -s -b 2 -c 0.35,0.55,0.85,0.25 -l $file && xclip -selection clipboard -t image/png -i $file
	fi
	notify_user
}

shot_5() {
	countdown '5'
	if [ "$XDG_SESSION_TYPE" == "wayland" ]; then 
		grim $file && wl-copy < $file
	else
		maim -u -f png $file && xclip -selection clipboard -t image/png -i $file
	fi
	notify_user
}

shot_10() {
	countdown '10'
	if [ "$XDG_SESSION_TYPE" == "wayland" ]; then 
		grim $file && wl-copy < $file
	else
		maim -u -f png $file && xclip -selection clipboard -t image/png -i $file
	fi	
	notify_user
}

docs () {
	echo "
Usage:	takeshot [Options]
    
Options:
    --now     -   Take screenshot of the desktop
    --win     -   Take screenshot of the focused window
    --area    -   Take screenshot of the selected area
    --in5     -   Take screenshot in 5 seconds
    --in10    -   Take screenshot in 10 seconds
	"
}

case $1 in
    --now)
	    shot
    ;;
	--win)
    	shot_window
    ;;
    --area)
	    shot_area
    ;;
	--in5)
	    shot_5
    ;;
    --in10)
	    shot_10
    ;;
    --help)
		docs
    ;;
esac

exit 0
