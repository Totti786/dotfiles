#!/usr/bin/env bash

CITY="Idlib"
COUNTRY="Syria"

DIR="$HOME/.config"
DAY="$(( $(date +"%d")-1))"
MONTH="$(date +"%m")"
YEAR="$(date +"%Y")"
prayer_rofi="$HOME/.cache/prayer_rofi_$DAY:$MONTH"
prayer_cache="$HOME/.cache/prayertimes_$MONTH:$YEAR"

convert(){
	if ! [[ "$1" < 12 ]]; then
		hr=$(echo "$1" | cut -d ":" -f1)
		mn=$(echo "$1" | cut -d ":" -f2)
		if [[ "$hr" == 12 ]]; then
			echo $hr:$mn "PM" 
		else
			echo $(( $hr - 12 )):$mn "PM" 
		fi
	else  
		ti=$(echo "$1" | sed 's/^0*//')
		echo $ti "AM"
	fi
}

if [ ! -f "$prayer_cache" ]; then
	echo `curl -X GET --header 'Accept: application/json'\
	"http://api.aladhan.com/v1/calendarByCity?city=$CITY&country=$COUNTRY&month=$MONTH&year=$YEAR&method=4"` > ${prayer_cache}
fi

if [ -f "$prayer_cache" ]; then
	if [ ! -f "$prayer_rofi" ]; then
		fajr=`convert $(cat $prayer_cache | jq -r ".data[$DAY].timings.Fajr" | cut -d " " -f1)`
		sunrise=`convert $(cat $prayer_cache | jq -r ".data[$DAY].timings.Sunrise" | cut -d " " -f1)`
		duhr=`convert $(cat $prayer_cache | jq -r ".data[$DAY].timings.Dhuhr" | cut -d " " -f1)`
		asr=`convert $(cat $prayer_cache | jq -r ".data[$DAY].timings.Asr" | cut -d " " -f1)`
		maghrib=`convert $(cat $prayer_cache| jq -r ".data[$DAY].timings.Maghrib" | cut -d " " -f1)`
		isha=`convert $(cat $prayer_cache | jq -r ".data[$DAY].timings.Isha" | cut -d " " -f1)`
		
		echo -e "City: $CITY \nFajr: $fajr \nSunrise: $sunrise \nDuhr: $duhr \nAsr: $asr \nMaghrib: $maghrib \nIsha: $isha" > ${prayer_rofi}
	fi
fi

cat $prayer_rofi | rofi -dmenu -p "Prayer Times" -theme "$DIR"/rofi/themes/prayer.rasi
