#!/usr/bin/env bash

# Variables and functions
POLYCONF="$HOME/.config/polybar"
MENUS_LIBDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"

if ! . "$MENUS_LIBDIR/pipemenu.cfg" 2> /dev/null; then
	echo "Error: Failed to locate pipemenu.cfg in $MENUS_LIBDIR" >&2
	exit 1
fi

if [[ -f "$HOME/.zprofile" ]]; then source "$HOME"/.zprofile ;else bar_style="base" ;fi

reload(){
	polytray="$(pgrep -a polybar  | grep systray | cut -d ' ' -f1)"
	"$HOME"/.config/polybar/launch.sh	
	[[ $(pgrep stalonetray) ]]
		pkill stalonetray && "$HOME"/.config/polybar/scripts/systray &
	[[ "$polytray" ]] && "$HOME"/.config/polybar/scripts/systray &
}

base(){
	sed -i 's/^bar_style=.*/bar_style=base/' "$HOME"/.zprofile
	conky.sh
	reload
}

minimal(){
	sed -i 's/^bar_style=.*/bar_style=minimal/' "$HOME"/.zprofile
	pkill conky
	reload
}

if  [[ "$1" = "-b" ]]; then
	base
elif  [[ "$1" = "-m" ]]; then
	minimal
elif  [[ "$1" = "-r" ]]; then
	reload
else
	menuStart
		menuSeparator "Polybar (${bar_style^})"
		menuSubmenu '' 'Change Style'
			menuItem 'Base' "$0 -b"
			menuItem 'Minimal' "$0 -m"
		menuSubmenuEnd
		menuItem 'Reload' "$0 -r"
		menuItem 'Edit Config' "exo-open $POLYCONF/$bar_style/config.ini"
		menuItem 'Edit Modules' "exo-open $POLYCONF/$bar_style/modules.ini"
		menuItem 'Edit Weather Data' "exo-open $POLYCONF/scripts/info"
	menuEnd
fi	
