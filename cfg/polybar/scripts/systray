#!/bin/bash

[[ -f "$HOME/.zprofile" ]] && source "$HOME/.zprofile"
[[ -z "$bar_style" ]] && bar_style="base"

hidden=/tmp/syshide.lock
display_resolution="$(xdpyinfo | awk '/dimensions/{print $2}' | cut -d 'x' -f1)"

main(){
polytray="$(pgrep -a polybar | grep systray | cut -d ' ' -f1)"
if [[ "$polytray" ]]; then
	if [[ ! -e "$hidden" ]]; then
		polybar-msg action "#systray.hook.1"
		xdo hide -p "$polytray" 
		touch "$hidden"
		killall -9 systray
	else
		polybar-msg action "#systray.hook.0"
		xdo show -p "$polytray" 
		rm "$hidden"
		sleep 5 && main
	fi
elif [[ "$(pidof stalonetray)" ]]; then
	if [[ ! -e "$hidden" ]]; then
		polybar-msg action "#systray.hook.1"
		xdo hide -n stalonetray
		touch "$hidden"
		killall -9 systray
	else
		polybar-msg action "#systray.hook.0"
		xdo show -n stalonetray
		xdo raise -n stalonetray
		rm "$hidden"
		sleep 5 && main
	fi
else
	if [[ "$XDG_CURRENT_DESKTOP" == "i3" ]]; then 
		polybar systray -q -c "$HOME/.config/polybar/$bar_style/config.ini" &
		main
	fi
	if [[ "$bar_style" == "minimal" ]]; then
		if [[ "$display_resolution" -gt "1920" ]]; then
			new="$(( "$display_resolution" - 1920 + 94 ))"
			stalonetray --geometry 1x1-"$new"-34 --grow-gravity SW &
			main			
		elif [[ "$display_resolution" -lt "1920" ]]; then
			stalonetray --geometry 1x1-66-34 --grow-gravity SW &
			main
		else
			stalonetray --geometry 1x1-94-34 --grow-gravity SW &
			main
		fi
	elif [[ "$bar_style" == "base" ]]; then
		if [[ "$display_resolution" -gt "1920" ]]; then
			new="$(( "$display_resolution" - 1920 + 4 ))"
			stalonetray --geometry 1x1-"$new"+27 &
			main			
		else
			stalonetray &
			main
		fi
	elif [[ "$bar_style" == "bionic" ]]; then
		if [[ "$display_resolution" -lt "1920" ]]; then
			stalonetray --geometry 1x1-66+45 &
			main
		else
			stalonetray --geometry 1x1-95+45 &
			main
		fi
	fi
fi
}
main 
